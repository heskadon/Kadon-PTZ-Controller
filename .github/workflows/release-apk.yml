name: üì¶Build, Upload & Release APK

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üì•Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚òïSet up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üîëDecode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/kadon-ptz.jks

      - name: ‚öôÔ∏èMake gradlew executable
        run: chmod +x ./gradlew

      - name: üè∑Ô∏èGet version name from Gradle
        id: get_version
        run: |
          VERSION_NAME=$(./gradlew -q printVersionName | grep -v "Starting" | grep -v "BUILD" | tr -d '\n')
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "Version name: $VERSION_NAME"

      - name: üè∑Ô∏èCreate tag if it doesn't exist
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git tag -a "v${{ env.VERSION_NAME }}" -m "Release v${{ env.VERSION_NAME }}" || echo "Tag already exists"
          git push origin "v${{ env.VERSION_NAME }}" || echo "Tag already pushed"

      - name: üì¶Build signed APK
        env:
          KEYSTORE_ALIAS: ${{ secrets.KEYSTORE_ALIAS }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleRelease

      - name: üîêGet Access Token
        run: |
          curl -X POST https://login.microsoftonline.com/${{ secrets.ONEDRIVE_TENANT_ID }}/oauth2/v2.0/token \
            -d "client_id=${{ secrets.ONEDRIVE_CLIENT_ID }}" \
            -d "scope=https://graph.microsoft.com/.default" \
            -d "client_secret=${{ secrets.ONEDRIVE_CLIENT_SECRET }}" \
            -d "grant_type=refresh_token" \
            -d "refresh_token=${{ secrets.ONEDRIVE_REFRESH_TOKEN }}" \
            -o token.json

      - name: ‚òÅÔ∏èUpload APK to OneDrive
        run: |
          ACCESS_TOKEN=$(jq -r .access_token token.json)
          APK_PATH=app/build/outputs/apk/release/app-release.apk
          if [ ! -f "$APK_PATH" ]; then
            APK_PATH=app/build/outputs/apk/release/com.kadon.ptzcontroller-${{ env.VERSION_NAME }}.apk
          fi
          curl -X PUT \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/vnd.android.package-archive" \
            --upload-file "$APK_PATH" \
            "https://graph.microsoft.com/v1.0/me/drive/root:/APK/$(basename "$APK_PATH"):/content"

      - name: üöÄCreate GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ env.VERSION_NAME }}
          name: "Release v${{ env.VERSION_NAME }}"
          body: "Automated release for version ${{ env.VERSION_NAME }}"
          draft: false
          prerelease: false
          artifacts: "app/build/outputs/apk/release/*.apk"
          token: ${{ secrets.GITHUB_TOKEN }}