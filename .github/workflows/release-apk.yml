name: üì¶Build, Upload & Release APK

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üì•Checkout code
        uses: actions/checkout@v4
        with:
          # Ensure we get the full history to handle tags properly
          fetch-depth: 0

      - name: ‚òïSet up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üîëDecode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/kadon-ptz.jks

      - name: ‚öôÔ∏èMake gradlew executable
        run: chmod +x ./gradlew

      - name: üè∑Ô∏èGet version name from Gradle
        id: get_version
        run: |
          # Extract version, filtering out Gradle noise
          VERSION_NAME=$(./gradlew -q printVersionName | grep -v "Starting" | grep -v "BUILD SUCCESSFUL" | grep -v "^$" | head -n 1 | xargs)
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "Extracted Version: $VERSION_NAME"

      - name: üì¶Build signed APK
        env:
          KEYSTORE_ALIAS: ${{ secrets.KEYSTORE_ALIAS }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleRelease

      - name: üöÄCreate GitHub Release and Upload APK
        uses: softprops/action-gh-release@v2  # Use the recommended v2
        with:
          tag_name: v${{ env.VERSION_NAME }} # Use the version from the environment
          name: "Release v${{ env.VERSION_NAME }}" # Use the version in the release name
          body: "Automated release for version ${{ env.VERSION_NAME }}"
          draft: false
          prerelease: false
          files: app/build/outputs/apk/release/*.apk # Upload the APK files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Pass the token correctly

      - name: üîêGet Access Token for OneDrive
        id: get_onedrive_token
        run: |
          curl -X POST https://login.microsoftonline.com/${{ secrets.ONEDRIVE_TENANT_ID }}/oauth2/v2.0/token \
            -d "client_id=${{ secrets.ONEDRIVE_CLIENT_ID }}" \
            -d "scope=https://graph.microsoft.com/.default" \
            -d "client_secret=${{ secrets.ONEDRIVE_CLIENT_SECRET }}" \
            -d "grant_type=refresh_token" \
            -d "refresh_token=${{ secrets.ONEDRIVE_REFRESH_TOKEN }}" \
            -o token.json
          # Extract token and make it available to next step
          ACCESS_TOKEN=$(jq -r .access_token token.json)
          echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT

      - name: ‚òÅÔ∏èUpload APK to OneDrive
        run: |
          # Find the correct APK file path - adjust if your build variant is different
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" -type f | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "Error: Could not find APK file in app/build/outputs/apk/release/"
            exit 1
          fi
          echo "Found APK at: $APK_PATH"

          ACCESS_TOKEN="${{ steps.get_onedrive_token.outputs.access_token }}"
          curl -X PUT \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/vnd.android.package-archive" \
            --upload-file "$APK_PATH" \
            "https://graph.microsoft.com/v1.0/me/drive/root:/APK/$(basename "$APK_PATH"):/content"