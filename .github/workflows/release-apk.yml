name: üì¶Build, Upload & Release APK

# Explicitly request permissions for the GITHUB_TOKEN
permissions:
  contents: write # This is crucial for creating releases
  # deployments: write # Uncomment if you also deploy using this token

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'      # Explicitly ignore the root README
      - '**.md'          # Ignore all other Markdown files (in any sub-directory)
      - 'docs/**'        # Ignore changes in a dedicated documentation directory
      - 'LICENSE'        # Ignore changes to the license file
      - '.gitignore'     # Ignore changes to gitignore file
      - 'assets/**'      # NEW: Common location for small assets/images for documentation
      - 'fastlane/**'    # NEW: Files often used for app store automation but not for building the APK

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üì•Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch full history as it might be needed for tag verification
          fetch-depth: 0

      - name: ‚òïSet up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üîëDecode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/kadon-ptz.jks

      - name: ‚öôÔ∏èMake gradlew executable
        run: chmod +x ./gradlew

      - name: üè∑Ô∏èGet version name from Gradle
        id: get_version
        run: |
          # Extract version, filtering out Gradle noise
          VERSION_NAME=$(./gradlew -q printVersionName | grep -v "Starting" | grep -v "BUILD SUCCESSFUL" | grep -v "^$" | head -n 1 | xargs)
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "Extracted Version: $VERSION_NAME"

      - name: üì¶Build signed APK
        env:
          KEYSTORE_ALIAS: ${{ secrets.KEYSTORE_ALIAS }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleRelease

      - name: üîéFind APK file
        id: find_apk
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" -type f | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "Error: Could not find APK file in app/build/outputs/apk/release/"
            exit 1
          fi
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "Found APK at: $APK_PATH"

      - name: üöÄUpload APK to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
          file: ${{ steps.find_apk.outputs.apk_path }}
          groups: testers

      - name: üöÄCreate GitHub Release and Upload APK
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION_NAME }}
          name: "Release v${{ env.VERSION_NAME }}"
          body: "Automated release for version ${{ env.VERSION_NAME }}"
          draft: false
          prerelease: false
          files: ${{ steps.find_apk.outputs.apk_path }}
        # The GITHUB_TOKEN is automatically provided and now has write permissions
        # due to the 'permissions:' block at the top of the workflow

      - name: üîêGet Access Token for OneDrive
        if: vars.UPLOAD_ONEDRIVE == 'true'
        id: get_onedrive_token
        run: |
          curl -X POST https://login.microsoftonline.com/${{ secrets.ONEDRIVE_TENANT_ID }}/oauth2/v2.0/token \
            -d "client_id=${{ secrets.ONEDRIVE_CLIENT_ID }}" \
            -d "scope=https://graph.microsoft.com/.default" \
            -d "client_secret=${{ secrets.ONEDRIVE_CLIENT_SECRET }}" \
            -d "grant_type=refresh_token" \
            -d "refresh_token=${{ secrets.ONEDRIVE_REFRESH_TOKEN }}" \
            -o token.json
          # Extract token and make it available to next step
          ACCESS_TOKEN=$(jq -r .access_token token.json)
          echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT

      - name: ‚òÅÔ∏èUpload APK to OneDrive
        if: vars.UPLOAD_ONEDRIVE == 'true'
        run: |
          ACCESS_TOKEN="${{ steps.get_onedrive_token.outputs.access_token }}"
          APK_PATH="${{ steps.find_apk.outputs.apk_path }}"
          curl -X PUT \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/vnd.android.package-archive" \
            --upload-file "$APK_PATH" \
            "https://graph.microsoft.com/v1.0/me/drive/root:/APK/$(basename "$APK_PATH"):/content"